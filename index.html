<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#317EFB" />
    <title>PWA href</title>
  </head>
  <body style="font-family: sans-serif; padding: 2rem">
    <h1>PWA V-1.4</h1>

    <a
      href="https://www.apple.com/legal/zip/2022-Supplemental-Data-File.zip"
      rel="noopener noreferrer"
      target="_self"
      >Noopener Download</a
    >
    <br />

    <a
      href="https://www.apple.com/legal/zip/2022-Supplemental-Data-File.zip"
      rel="noopener noreferrer"
      target="_blank"
      >Blank Download</a
    >
    <br />

    <a
      download
      href="https://www.apple.com/legal/zip/2022-Supplemental-Data-File.zip"
      rel="noopener noreferrer"
      target="_self"
      >Noopener Download Tagged</a
    >
    <br />

    <a
      download
      href="https://www.apple.com/legal/zip/2022-Supplemental-Data-File.zip"
      rel="noopener noreferrer"
      target="_blank"
      >Blank Download Tagged</a
    >
    <br />
    <br />

    <button id="downloadBtn">Download CSV from S3</button>
    <br />
    <br />

    <button id="updateBtn">Update PWA</button>
    <br />
    <br />

    <button id="reloadBtn">Reload App</button>

    <script>
      // Register the service worker
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker
          .register("service-worker.js")
          .then(() => console.log("Service Worker registered"))
          .catch((err) => console.error("Service Worker failed:", err));
      }

      async function downloadFileAsync() {
        const fileUrl =
          "https://unifize-jq1gj9dpvw.s3.us-east-2.amazonaws.com/413/6bd5a0d0-bf25-49c1-8b0f-ffacc0a77576?versionId=e5pExrAwV4bm0Bxg6qIZ5sddUP8papta&response-content-disposition=attachment%3B%20filename%3D%22Linked%2520template%2520%25286%2529.csv%22&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Date=20250924T113127Z&X-Amz-SignedHeaders=host&X-Amz-Expires=3600&X-Amz-Credential=AKIARXEUVTHULHTPBBVW%2F20250924%2Fus-east-2%2Fs3%2Faws4_request&X-Amz-Signature=b28bef520a26b22db485ea1a4cede83fa100df1942abc3383d7759a954a4d156";

        const response = await fetch(fileUrl);
        if (response.status > 299)
          window.location =
            window.location.origin + "/statuscode/" + response.status;

        let filename = "downloaded-file";
        const contentDisposition = response.headers.get("Content-Disposition");
        if (contentDisposition) {
          const filenameMatch =
            contentDisposition.match(/filename\*=(?:UTF-8'')?(.+?)(?:;|$)/) ||
            contentDisposition.match(/filename="(.+?)"/);

          if (filenameMatch && filenameMatch.length > 1) {
            filename = decodeURIComponent(filenameMatch[1].replace(/"/g, ""));
          }
        }

        const blob = await response.blob();
        const downloadUrl = URL.createObjectURL(blob);
        const anchorElement = document.createElement("a");
        anchorElement.href = downloadUrl;
        anchorElement.download = filename ?? "";
        anchorElement.click();
        anchorElement.remove();
        URL.revokeObjectURL(downloadUrl);
      }

      function updateApp() {
        console.log("Updating app..");
        navigator.serviceWorker.getRegistration().then((reg) => {
          if (!reg) return;

          // Force service worker to fetch latest SW
          reg.update().then(() => {
            if (reg.waiting) {
              // Tell waiting SW to skip waiting and take control
              reg.waiting.postMessage({ type: "UPDATE_APP" });
            }
          });
        });
      }

      function reloadApp() {
        console.log("Reloading app...");
        window.location.reload();
      }

      document
        .getElementById("downloadBtn")
        .addEventListener("click", downloadFileAsync);

      document.getElementById("updateBtn").addEventListener("click", updateApp);

      document.getElementById("reloadBtn").addEventListener("click", reloadApp);

      navigator.serviceWorker.addEventListener("controllerchange", reloadApp);
    </script>
  </body>
</html>
